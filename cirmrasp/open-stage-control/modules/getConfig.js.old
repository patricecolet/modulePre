// var path = nativeRequire('path')
app.on('sessionOpened',  (data, client) => {
	const  config = loadJSON('../../../config.json');
	let err = "";
	var info = "";
	try {
		compo = config.compositions;
		err = ": JSON is okay";
 	}
	catch (e) {
		err = ": JSON is malformed: " + e.message;
	}
//	var switchHeight = Object.keys(compo).length * 40;
	var compoTabs = [];
	compo.forEach((p, i) => {
		let trackConfig = "empty";
		compoPath = "../../../PureData/compositions/" + p.title + "/trackConfig.json";
	//	trackConfig = loadJSON(compoPath);
//		var path = path.dirname("/home/pi");
        //        info += "trackConfig: " + path + "\n";
        try {
//                test = trackConfig.globalSettings;
                err += ": JSON is okay";

        }
        catch (e) {
                err += ": JSON is malformed: " + e.message;
		console.log(": JSON is malformed: " + e.message);
        }
		compoTabs[i] = {
        "type": "tab",
        "lock": false,
        "id": p.title,
        "visible": true,
        "interaction": true,
        "comments": "",
        "colorText": "auto",
        "colorWidget": "auto",
        "colorFill": "auto",
        "borderRadius": "auto",
        "padding": "auto",
        "html": "",
        "css": "",
        "colorBg": "auto",
        "layout": "default",
        "justify": "start",
        "gridTemplate": "",
        "contain": true,
        "scroll": true,
        "innerPadding": true,
        "tabsPosition": "top",
        "label": p.title,
        "variables": "@{parent.variables}",
        "traversing": false,
        "value": "",
        "default": "",
        "linkId": "",
        "address": "auto",
        "preArgs": "",
        "typeTags": "",
        "decimals": 2,
        "target": "",
        "ignoreDefaults": false,
        "bypass": false,
        "onCreate": "",
        "onValue": "",
        "widgets": [
      {
        "type": "fragment",
        "top": 0,
        "left": 0,
        "lock": false,
        "id": "fragment_1",
        "visible": true,
        "interaction": true,
        "comments": "",
        "width": "1200",
        "height": "800",
        "expand": "false",
        "css": "",
        "file": "../../../PureData/compositions/" + p.title + "/interface.json",
        "fallback": "",
        "props": {},
        "address": "auto",
        "variables": "@{parent.variables}"
      },      {
        "type": "variable",
        "lock": false,
        "id": p.title + "-config",
        "comments": "",
        "value": trackConfig,
        "default": "",
        "linkId": "",
        "address": "auto",
        "preArgs": "",
        "typeTags": "",
        "decimals": 2,
        "target": "",
        "ignoreDefaults": false,
        "bypass": false,
        "onCreate": "",
        "onValue": ""
      }
     ],
        "tabs": []
      }
    })
	receive('/NOTIFY', 'hand',err); 
	receive('/NOTIFY', 'hand',info); 
	receive('/EDIT','Compositions', {
		'tabs' : compoTabs,
	//	'height' : switchHeight
	}, {clientId: client.id});
        receive('/EDIT','config', {
                'value' : config,
        }, {clientId: client.id});
})

module.exports = {

    oscInFilter:function(data){

        var {address, args, host, port} = data

        if (address === '/some_address') {

            args[0].value = args[0].value * 10

        }

        return {address, args, host, port}

    },

    oscOutFilter:function(data){

        var {address, args, host, port, clientId} = data

        if (address === '/some_address') {

            args[0].value = args[0].value / 10

        }

        return {address, args, host, port}
    }

}
